<tool id="pm_dftb_opt_write" name="DFTB+ write" version="0.1.0" python_template_version="3.5" profile="22.01">
    <description>generate DFTB+ outputs</description>
    <macros>
        <!-- citation should be updated with every underlying tool version -->
        <!-- typical fields to update are version, month, year, and doi -->
        <token name="@PYMUONSUITE_CITATION@">
            @software{pymuon-suite,
                author = {Sturniolo, Simone and Liborio, Leandro and Chadwick, Eli and Murgatroyd, Laura and Laverack, Adam and {Muon Spectroscopy Computational Project}},
                license = {GPL-3.0},
                title = {{pymuon-suite}},
                url = {https://github.com/muon-spectroscopy-computational-project/pymuon-suite},
                version = {v0.2.1},
                month = {2},
                year = {2022},
                doi = {}
            }
        </token>
    </macros>
    <creator>
        <person givenName="Jyothish" familyName="Thomas" identifier="https://orcid.org/0000-0003-4724-6924"/>
        <person givenName="Eli" familyName="Chadwick" url="https://github.com/elichad" identifier="https://orcid.org/0000-0002-0035-6475"/>
        <organization url="https://muon-spectroscopy-computational-project.github.io/index.html" name="The Muon Spectroscopy Computational Project"/>
    </creator>
    <requirements>
        <!-- note versioning is different due to multiple dependencies -->
        <requirement type="package" version="21.2">dftbplus</requirement>
        <requirement type="package" version="0.2.1">pymuonsuite</requirement>
        <requirement type="package" version="3.0">zip</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        unzip "$muonated_structures" &&
        if test -f "params.yaml"; then echo "params.yaml present"; else echo "params.yaml missing" && exit 64; fi
        && if ( test -f input_structure.* ) ; then echo "input structure present"; else echo "input structure missing" && exit 64; fi
        && out_folder="`python ${__tool_directory__}/get_out_folder.py`" ;
        bash ${__tool_directory__}/run.sh \$out_folder ;
        passed=$? &&
        echo \$passed &&
        if [ \$passed == 2 ]; then echo "input file structure is not dftb" && exit 25; elif [ \$passed == 3 ]; then echo "error in parsing dftb file. check log for details" && exit 26; else echo "parse ok"; fi &&
        if grep -q 'pbc-0-3' params.yaml; then cp ${__tool_directory__}/README-pbc \$out_folder/README; elif grep -q '3ob-3-1' params.yaml; then cp ${__tool_directory__}/README-3ob \$out_folder README; else ( cp ${__tool_directory__}/README-3ob \$out_folder README-3ob && cp ${__tool_directory__}/README-pbc \$out_folder/README-pbc ); fi;
        zip -r dftb_results.zip \$out_folder params.yaml input_structure.* &&
        find \$out_folder > tree.txt
    ]]></command>
    <inputs>
        <param type="data" name="muonated_structures" label="Muonated structures (.zip)" format="zip" help="A zip folder containing muonated structures, as generated by the 'Generate muonated structures' tool or pm-muairss."/>
    </inputs>
    <outputs>
        <data label="DFTB results for $muonated_structures.name" name="dftb_results" format="zip" from_work_dir="dftb_results.zip"/>
        <data label="file tree for testing" name="file_tree" format="txt" from_work_dir="tree.txt" hidden="true"/>
    </outputs>
    <tests>
        <test>
            <param name="muonated_structures" value="muonated-dftb.zip" ftype="zip"/>
            <output name="file_tree" file="tree.txt" ftype="txt" compare="sim_size" delta="450"/>
        </test>
    </tests>
    <help><![CDATA[
        usage: dftb+
        Given some input muonated structures (structures containing a muon), applies DFTB+ optimization to refine them.

        **LICENSE**

        All data is licensed under the Creative Commons Attribution-ShareAlike 4.0
        International License. The full text of the license can be found at:

        https://creativecommons.org/licenses/by-sa/4.0/legalcode

        For specific data sets remember to cite the following papers, by element :

|        **3-ob-1**


+--------------+------------------------------------------------+-----------------------------------+------------------------------------+
| [JCTC2013]   | \ J. Chem. Theory Comput., 2013, 9, 338-354.   | (O, N, C, H)                      | https://doi.org/10.1021/ct300849w  |
+--------------+------------------------------------------------+-----------------------------------+------------------------------------+
| [JCTC2014]   | \ J. Chem. Theory Comput., 2014, 10, 1518-1537.| (P,S-\*)                          | https://doi.org/10.1021/ct401002w  |
+--------------+------------------------------------------------+-----------------------------------+------------------------------------+
| [JCTC2015-1] | \ J. Phys. Chem. B, 2015, 119, 1062-1082.      | (Mg,Zn-\*)                        | https://doi.org/10.1021/jp506557r  |
+--------------+------------------------------------------------+-----------------------------------+------------------------------------+
| [JCTC2015-2] | \ J. Chem. Theory Comput., 2015, 11, 332-342.  | (Na,F,K,Ca,Cl,Br,I-\*)            | https://doi.org/10.1021/ct5009137  |
+--------------+------------------------------------------------+-----------------------------------+------------------------------------+

|
|    **pbc-0-3**

+------------+--------------------------------------------------------------------------------------------+---------+------------------------------------------------+
|   [SiC]    | \ E. Rauls, R. Gutierrez, J. Elsner, and Th. Frauenheim, Sol. State Comm. 111, 459 (1999)  | (Si-C)  | https://doi.org/10.1016/S0038-1098(99)00137-4  |
+------------+--------------------------------------------------------------------------------------------+---------+------------------------------------------------+
|   [SiO]    | \ C. Koehler, Z. Hajnal, P. Deak, Th. Frauenheim, S. Suhai, Phys. Rev. B 64, 085333 (2001) |  (Si-O) | https://doi.org/10.1103/PhysRevB.64.085333     |
+------------+--------------------------------------------------------------------------------------------+---------+------------------------------------------------+
| [Silicon]  | \ A. Sieck, Th. Frauenheim, and K. A. Jackson, phys. stat. sol. (b) 240, 537 (2003).       |  (Si)   | https://doi.org/10.1002/pssb.200301886         |
+------------+--------------------------------------------------------------------------------------------+---------+------------------------------------------------+
| [Fluorine] | \ C. Koehler and Th. Frauenheim, Surf. Sci. 600, 453 (2006).                               | \ (F)   | https://doi.org/10.1016/j.susc.2005.10.044     |
+------------+--------------------------------------------------------------------------------------------+---------+------------------------------------------------+
|   [Iron]   | \ C. Koehler, G. Seifert and Th. Frauenheim, Chem. Phys. 309, 23 (2005).                   |   (Fe)  | https://doi.org/10.1016/j.chemphys.2004.03.034 |
+------------+--------------------------------------------------------------------------------------------+---------+------------------------------------------------+
|   [SiSi]   | \ A. Sieck, PhD. Thesis, University of Paderborn, 2000.                                    | (Si-Si) | https://www.osti.gov/etdeweb/biblio/20249635   |
+------------+--------------------------------------------------------------------------------------------+---------+------------------------------------------------+

|
| The full sets and all other data can be found at the following URLs:

+----------+------------------------------------------------------------+
|  3-ob-1  |   https://www.dftb.org/parameters/download/3ob/3ob-3-1-cc/ |
+----------+------------------------------------------------------------+
| pbc-0-3  |  https://www.dftb.org/parameters/download/pbc/pbc-0-3-cc/  |
+----------+------------------------------------------------------------+
    ]]></help>
    <citations>
        <citation type="bibtex">
            @PYMUONSUITE_CITATION@
        </citation>
        <citation type="bibtex">
        @article{doi:10.1063/1.5143190,
         author = {Hourahine,B.  and Aradi,B.  and Blum,V.  and Bonafé,F.  and Buccheri,A.  and Camacho,C.  and Cevallos,C.  and Deshaye,M. Y.  and Dumitrică,T.  and Dominguez,A.  and Ehlert,S.  and Elstner,M.  and van der Heide,T.  and Hermann,J.  and Irle,S.  and Kranz,J. J.  and Köhler,C.  and Kowalczyk,T.  and Kubař,T.  and Lee,I. S.  and Lutsker,V.  and Maurer,R. J.  and Min,S. K.  and Mitchell,I.  and Negre,C.  and Niehaus,T. A.  and Niklasson,A. M. N.  and Page,A. J.  and Pecchia,A.  and Penazzi,G.  and Persson,M. P.  and Řezáč,J.  and Sánchez,C. G.  and Sternberg,M.  and Stöhr,M.  and Stuckenberg,F.  and Tkatchenko,A.  and Yu,V. W.-z.  and Frauenheim,T. },
         title = {DFTB+, a software package for efficient approximate density functional theory based atomistic simulations},
         journal = {The Journal of Chemical Physics},
         volume = {152},
         number = {12},
         pages = {124101},
         year = {2020},
         doi = {10.1063/1.5143190},

         URL = {
                 https://doi.org/10.1063/1.5143190

         },
         eprint = {
                 https://doi.org/10.1063/1.5143190
         }
         }
        </citation>
    </citations>
</tool>
